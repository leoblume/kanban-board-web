<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Migra√ß√£o de Dados do Kanban</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        h1 { color: #333; }
        #log { border: 1px solid #ccc; background-color: #fff; padding: 15px; margin-top: 20px; height: 400px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { font-size: 18px; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Ferramenta de Migra√ß√£o de Dados</h1>
    <p>Esta p√°gina ir√° verificar todas as suas tarefas no banco de dados e adicionar os campos necess√°rios (`deliveryDate` e `order`) para que o novo sistema funcione corretamente.</p>
    <button id="start-migration-button">Iniciar Migra√ß√£o</button>
    
    <h2>Log de Progresso:</h2>
    <div id="log">Aguardando in√≠cio...</div>

    <script type="module">
        // --- In√≠cio do Script de Migra√ß√£o ---

        import { getFirestore, collection, getDocs, writeBatch, doc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";

        // Cole sua configura√ß√£o do Firebase aqui
        const firebaseConfig = {
          apiKey: "AIzaSyALCIfOdzUrbzs8_ceXXYFwsCeT161OFPw",
          authDomain: "kanban-board-92ce7.firebaseapp.com",
          projectId: "kanban-board-92ce7",
          storageBucket: "kanban-board-92ce7.appspot.com",
          messagingSenderId: "494809291125",
          appId: "1:494809291125:web:17f9eefa4287d39174db3c"
        };

        const logElement = document.getElementById('log');
        const startButton = document.getElementById('start-migration-button');

        function log(message, type = '') {
            console.log(message);
            logElement.innerHTML += `<span class="${type}">${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight; // Rola para o final
        }

        function convertDateToSortable(dateStr) {
            if (!dateStr || !dateStr.includes('/')) return '9999-12-31';
            const parts = dateStr.split('/');
            if (parts.length < 2 || isNaN(parseInt(parts[0])) || isNaN(parseInt(parts[1]))) return '9999-12-31';
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = (parts[2] && parts[2].length === 4) ? parts[2] : new Date().getFullYear();
            return `${year}-${month}-${day}`;
        }

        async function runMigration() {
            startButton.disabled = true;
            startButton.textContent = "Migra√ß√£o em progresso...";
            log("üöÄ Iniciando script de migra√ß√£o...", "info");

            const app = initializeApp(firebaseConfig, "migrationApp" + Date.now()); // Nome √∫nico para a app
            const db = getFirestore(app);
            const tasksCollectionRef = collection(db, "tasks");
            
            try {
                const querySnapshot = await getDocs(tasksCollectionRef);
                const batch = writeBatch(db);
                let updatesNeeded = 0;

                log(`Encontradas ${querySnapshot.size} tarefas para verifica√ß√£o.`, "info");

                querySnapshot.forEach((document) => {
                    const data = document.data();
                    let needsUpdate = false;
                    const updates = {};

                    // Verifica se 'deliveryDate' existe.
                    if (data.deliveryDate === undefined) {
                        const entregaStatus = data.statuses.find(s => s.id === 'entrega');
                        updates.deliveryDate = convertDateToSortable(entregaStatus?.date || '');
                        needsUpdate = true;
                        log(`- Tarefa ${document.id}: Campo 'deliveryDate' ser√° adicionado.`);
                    }

                    // Verifica se 'order' existe.
                    if (data.order === undefined) {
                        updates.order = 0; // Valor padr√£o
                        needsUpdate = true;
                        log(`- Tarefa ${document.id}: Campo 'order' ser√° adicionado.`);
                    }

                    if (needsUpdate) {
                        const docRef = doc(db, "tasks", document.id);
                        batch.update(docRef, updates);
                        updatesNeeded++;
                    }
                });

                if (updatesNeeded > 0) {
                    log(`\nEnviando ${updatesNeeded} atualiza√ß√µes para o banco de dados...`, "info");
                    await batch.commit();
                    log("\nüéâüéâ SUCESSO! Migra√ß√£o conclu√≠da! üéâüéâ", "success");
                    log("Todas as tarefas foram atualizadas. Agora voc√™ pode voltar para a p√°gina principal (index.html) e recarreg√°-la.", "success");
                } else {
                    log("\nüëç Nenhuma tarefa precisou de migra√ß√£o. Seus dados j√° est√£o corretos.", "success");
                }

            } catch (error) {
                log(`\n‚ùå ERRO DURANTE A MIGRA√á√ÉO: ${error.message}`, "error");
            } finally {
                startButton.disabled = false;
                startButton.textContent = "Iniciar Migra√ß√£o Novamente";
            }
        }

        startButton.addEventListener('click', runMigration);

        // --- Fim do Script de Migra√ß√£o ---
    </script>
</body>
</html>